<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="viewport"
        content="width=device-width,minimum-scale=1.0,maximum-scale=1.0,initial-scale=1.0,user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <title>用户组</title>

    <link rel="stylesheet" type="text/css" href="/extends/release/Content/css.css" />
    <link rel="stylesheet" type="text/css" href="/extends/release/Scripts/jquery-easyui/themes/insdep/css.css" />

    <link rel="stylesheet" type="text/css" href="/style/base.css" />
    <link rel="stylesheet" type="text/css" href="/style/index.css" />
    <link rel="stylesheet" type="text/css" href="/style/cruq.css" />

    <script type="text/javascript" charset="utf-8" src="/extends/release/Scripts/jquery.js"></script>
    <script type="text/javascript" charset="utf-8" src="/extends/release/Scripts/jquery-easyui/themes/insdep/js.js"></script>
    <script type="text/javascript" charset="utf-8" src="/extends/release/Scripts/indexjs.js"></script>

    <script type="text/javascript" charset="utf-8" src="/scripts/base.js"></script>
    <script type="text/javascript" charset="utf-8" src="/scripts/appConfig.js"></script>
    <script type="text/javascript" charset="utf-8" src="/scripts/app.js"></script>
    <script type="text/javascript" charset="utf-8" src="/scripts/cruq.js"></script>
</head>
<body>
    <div class="ibox">
        <div class="ibox-content">
            <div class="easyui-panel CRUQBasicPage">
                <div id="search" class="easyui-panel" title="查询条件" iconcls="icon-search" style="padding: 10px; margin-bottom: 10px;">
                    <form id="search_form" onSubmit="return page.Search()">
                        <div class="search_item">
                            <label>添加时间:</label>
                            <input name="AddTimeStart" class="easyui-datetimebox" data-options="showSeconds:false" />
                            -
                            <input name="AddTimeEnd" class="easyui-datetimebox" data-options="showSeconds:false" />
                        </div>
                        <span class="search_item">
                            <button type="submit" class="easyui-linkbutton" iconCls="icon-magnifier" style="width:80px;">搜索</button>
                        </span>
                        <span class="search_item">
                            <button type="button" class="easyui-linkbutton" iconcls="icon-remove" style="width:120px;"
                                onclick="$(this).parents('form').form('clear');">清除条件</button>
                        </span>
                    </form>
                </div>

                <div id="toolbar">
                    <button class="easyui-linkbutton operating_Add"iconcls="icon-add" onclick="page.Create()">添加</button>
                    <button class="easyui-linkbutton operating_Edit" iconcls="icon-edit" onclick="page.Edit()">修改</button>
                    <button class="easyui-linkbutton operating_Delete" iconcls="icon-delete" onclick="page.Remove()">删除</button>
                </div>
                <table id="datagrid" class="easyui-datagrid"
                    style="padding: 10px;"
                    data-options="
                        title:'提成比例',
                        toolbar:'#toolbar',
                        iconcls:'icon-application_view_list',
                        pagination:true,
                        pageSize:10,
                        pageList:[10,20,30,40,50],
                        sortName:'ID',
                        sortOrder:'desc',
                        singleSelect:true,
                        fitColumns:true,
                        striped:true,
                        url:Api.UrlFormat('/api/UserGroup/GetUserGroupList'),
                        method:'get',
                        queryParams:$('#search_form').serializeJSON(),
                        onDblClickRow:function(){ page.Edit();},
                    ">
                    <thead>
                        <tr>
                            <th field="Check" checkbox="true" width="40"></th>
                            <th field="ID" width="50" sortable="true">ID</th>
                            <th field="GroupName" width="120">组名</th>
                            <th field="Remark" width="120">备注</th>
                            <th field="AddTime" width="160"
                                data-options="formatter:function(value,row,index){return value == null ? '' : new Date(value).FormatAsString(); }">添加时间</th>
                            <th field="AddManagerName" width="120">添加者</th>
                        </tr>
                    </thead>
                </table>

                <div id="dialog" class="easyui-dialog" href="UserGroupEdit.html" cache="false"
                     buttons="#dialog-buttons" style="width: 450px;"
                     closed="true" modal="true" iconCls="icon-save"></div>
                <div id="dialog-buttons">
                    <button type="button" class="easyui-linkbutton" iconCls="icon-ok"
                        onclick="page.Save()">保存</button>
                    <button type="button" class="easyui-linkbutton" iconCls="icon-cancel"
                        onclick="$('#dialog').dialog('close')">取消</button>
                </div>
            </div>
        </div>
    </div>
    <script type="text/javascript">
        var page = {
            GetSearchData: function() {
                return $('#search_form').serializeJSON();
            },
            Search: function() {
                $('#datagrid').datagrid('load', this.GetSearchData());
                return false;
            },
            Create: function() {
                var self = this;
                $('#dialog').dialog('open').dialog('setTitle', '添加用户组');
            },
            Edit: function() {
                var self = this;
                var row = $('#datagrid').datagrid('getSelected');
                if (!row) {
                    $.messager.alert("提示", "未选择数据！", "info");
                    return;
                }
                $('#dialog').dialog({
                    onLoad: function() {
                        $(this).window('center');
                        $('#dialog-form').form('load', row);
                    },
                });
                $('#dialog').dialog('open').dialog('setTitle', '编辑用户组');
            },
            Remove: function() {
                var rows = $('#datagrid').datagrid('getSelections');
                if (!rows.length) {
                    $.messager.alert({
                        title: '提示',
                        msg: '请选择要删除的项。',
                        icon: 'info'
                    });
                    return;
                }
                $.messager.confirm('提示', '确认删除选中的项？', function(isOk) {
                    if (!isOk)
                        return;
                    var ids = [];
                    for (var i = 0; i < rows.length; i++) {
                        var id = Object.get(rows[i], 'ID', '');
                        if (id)
                            ids.push(id);
                    }
                    Api.CallPost({
                        'url': Api.UrlFormat('/api/UserGroup/DeleteUserGroups'),
                        'data': {
                            'IDs': ids,
                        },
                        success: function (json) {
                            json = json || {};
                            if (Object.get(json, 'Code', 404) != 200) {
                                $.messager.alert({
                                    title: '提示',
                                    msg: Object.get(json, 'Message', '错误请求'),
                                    icon: 'error'
                                });
                                return;
                            }
                            $('#dialog').dialog('close');
                            $('#datagrid').datagrid('reload');
                        },
                        error: function(xhr) { self.errorMethod(xhr) },
                    });
                });
            },
            Save: function() {
                var self = this;
                if (!$('#dialog-form').form('validate')) {
                    $.messager.alert({
                        title: '提示',
                        msg: '数据校验不通过, 请检查',
                        icon: 'error'
                    });
                    return false;
                }
                var model = $('#dialog-form').serializeJSON();
                Api.CallPost({
                    'url': Api.UrlFormat('/api/UserGroup/EditUserGroup'),
                    'data': {
                        'model': model,
                    },
                    success: function (json) {
                        json = json || {};
                        if (Object.get(json, 'Code', 404) != 200) {
                            $.messager.alert({
                                title: '提示',
                                msg: Object.get(json, 'Message', '错误请求'),
                                icon: 'error'
                            });
                            return;
                        }
                        $('#dialog').dialog('close');
                        if (Object.get(model, 'ID', 0) == 0) {
                            $('#datagrid').datagrid('load');
                        } else {
                            $('#datagrid').datagrid('reload');
                        }
                    },
                    error: function(xhr) { self.errorMethod(xhr) },
                });
            },
            errorMethod: function(xhr) {
                var responseJSON = Object.get(xhr, 'responseJSON', {});
                var responseStatus = Object.get(responseJSON, 'status', 0);
                var responseTitle = Object.get(responseJSON, 'title', '');
                var status = Object.get(xhr, 'status', 0);
                var statusText = Object.get(xhr, 'statusText', '');
                $.messager.alert({
                    title: '提示',
                    msg: responseTitle || statusText,
                    icon: 'error'
                });
            },
        };
    </script>
</body>
</html>
